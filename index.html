<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frais Kilométriques SALC</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary:#2563eb; --primary-dark:#1d4ed8; --secondary:#475569; --tertiary:#94a3b8;
      --text:#1e293b; --text-secondary:#64748b; --danger:#ef4444; --success:#22c55e; --warning:#f97316; --info:#3b82f6;
      --border:#cbd5e1; --card-bg:#ffffff; --input-bg:#f8fafc; --hover-bg:#f1f5f9; --background:#f1f5f9;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--background);color:var(--text);line-height:1.6;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--card-bg);border-radius:12px;padding:20px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;border:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .app-title{display:flex;align-items:center;gap:16px}
    .app-title img{height:40px;width:auto}
    .app-title h1{font-weight:700;font-size:24px;color:var(--primary)}
    .card{background:var(--card-bg);border-radius:12px;padding:24px;margin-bottom:24px;border:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.08)}
    h2{font-size:20px;margin:0 0 20px;color:var(--text);display:flex;align-items:center;gap:10px;padding-bottom:12px;border-bottom:2px solid var(--primary)}
    h2 i{color:var(--primary)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
    /* Force 4 colonnes alignées pour le bloc Nouveau trajet */
    .form-grid-4{grid-template-columns:repeat(4,1fr)}
    .form-group{display:flex;flex-direction:column;gap:8px}
    label{font-size:14px;color:var(--text-secondary);font-weight:500}
    input,select,textarea{height:48px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:0 16px;font-size:16px;outline:none;width:100%;transition:.2s}
    textarea{height:100px;padding:12px 16px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    button{height:48px;border:0;border-radius:8px;background:var(--primary);color:#fff;padding:0 24px;cursor:pointer;font-size:16px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.2s}
    button:hover{background:var(--primary-dark);transform:translateY(-2px)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-secondary{background:var(--tertiary)}.btn-secondary:hover{background:#7c8ba1}
    .btn-danger{background:var(--danger)}.btn-danger:hover{background:#dc2626}
    .btn-success{background:var(--success)}.btn-success:hover{background:#16a34a}
    .btn-warning{background:var(--warning)}.btn-warning:hover{background:#ea580c}
    .checkbox-group{display:flex;align-items:center;gap:10px}
    .checkbox-group input{width:20px;height:20px}
    .summary{margin-top:24px;padding:20px;border:2px dashed var(--border);border-radius:12px;background:var(--input-bg);display:flex;justify-content:space-between;gap:24px;flex-wrap:wrap}
    .summary-item{display:flex;flex-direction:column;gap:8px}
    .summary-label{font-size:14px;color:var(--text-secondary)}
    .summary-value{font-weight:700;font-size:24px;color:var(--primary)}
    table{width:100%;border-collapse:collapse;margin-top:24px;font-size:14px;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    th,td{padding:16px 12px;text-align:left;border-bottom:1px solid var(--border)}
    th{color:var(--text-secondary);font-weight:600;font-size:13px;background:var(--input-bg)}
    tr:hover{background:var(--hover-bg)}
    .tabs{display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid var(--border);padding-bottom:8px}
    .tab{padding:12px 24px;border-radius:8px 8px 0 0;cursor:pointer;background:var(--input-bg);font-size:14px;font-weight:500;transition:.2s;display:flex;align-items:center;gap:8px;border:1px solid transparent}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .tab-content{display:none}.tab-content.active{display:block}
    .mobile-hidden{display:table-cell}
    .notification{position:fixed;top:24px;right:24px;padding:16px 20px;border-radius:8px;background:var(--success);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15);transform:translateX(100%);transition:transform .3s;z-index:1000;display:flex;align-items:center;gap:12px;max-width:420px}
    .notification.show{transform:translateX(0)}.notification.error{background:var(--danger)}.notification.warning{background:var(--warning)}
    .autocomplete{position:relative}
    .autocomplete-list{position:absolute;top:100%;left:0;right:0;background:var(--input-bg);border:1px solid var(--primary);border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .autocomplete-item{padding:12px 16px;cursor:pointer;transition:background .2s}
    .autocomplete-item:hover{background:var(--hover-bg)}
    .recurrence-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
    .recurrence-modal.active{display:flex}
    .recurrence-content{background:var(--card-bg);border-radius:12px;padding:24px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,.2)}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:16px 0}
    .calendar-header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:10px;flex-wrap:wrap}
    .calendar-weekday{text-align:center;font-weight:600;color:var(--text-secondary);padding:8px}
    .calendar-day{height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;transition:.2s;border:1px solid var(--border)}
    .calendar-day:hover{background:var(--hover-bg)}
    .calendar-day.selected{background:var(--primary);color:#fff;border-color:var(--primary)}
    .calendar-day.disabled{color:var(--tertiary);cursor:not-allowed;background:var(--input-bg)}
    .calendar-day.today{border:2px solid var(--primary)}
    /* Motifs sur une seule ligne avec scroll horizontal */
    .motif-select{display:flex;flex-wrap:nowrap;gap:10px;margin:16px 0;overflow-x:auto}
    .motif-option{padding:10px 16px;background:var(--input-bg);border-radius:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:8px;border:1px solid var(--border);flex:0 0 auto;white-space:nowrap}
    .motif-option.selected{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .badge-primary{background:var(--primary);color:#fff}
    .import-section{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
    .file-input{display:none}
    .file-label{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;background:var(--tertiary);border-radius:8px;cursor:pointer;transition:.2s;color:#fff}
    .file-label:hover{background:#7c8ba1}
    .address-fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .export-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .month-selector{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .stats-container{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    @media (max-width:768px){
      .mobile-hidden{display:none}
      .form-grid{grid-template-columns:1fr}
      .form-grid-4{grid-template-columns:1fr}
      .tabs{overflow-x:auto;padding-bottom:4px}
      .tab{white-space:nowrap}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="app-title">
      <img id="logo" alt="Logo SALC" />
      <h1>Frais Kilométriques SALC</h1>
    </div>
    <div id="moisBadge" class="badge badge-primary"></div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="user"><i class="fas fa-user"></i> Utilisateur</div>
    <div class="tab" data-tab="trips"><i class="fas fa-route"></i> Trajets</div>
    <div class="tab" data-tab="routes"><i class="fas fa-map-marked-alt"></i> Itinéraires</div>
    <div class="tab" data-tab="settings"><i class="fas fa-cog"></i> Paramètres</div>
  </div>

  <!-- Utilisateur -->
  <div class="tab-content active" id="user-tab">
    <div class="card">
      <h2><i class="fas fa-user-circle"></i> Informations utilisateur</h2>
      <div class="form-grid">
        <div class="form-group"><label for="uNom">Nom et prénom</label><input id="uNom" placeholder="Votre nom" autocomplete="name" /></div>
        <div class="form-group"><label for="uMail">Email (optionnel)</label><input id="uMail" type="email" placeholder="nom@domaine.fr" autocomplete="email" /></div>
        <div class="form-group"><label for="uPrix">Prix du kilomètre (€)</label><input id="uPrix" type="number" step="0.001" min="0" placeholder="0.320" value="0.320" /></div>
      </div>

      <h2><i class="fas fa-car"></i> Informations véhicule</h2>
      <div class="form-grid">
        <div class="form-group"><label for="uVehicule">Nom du véhicule</label><input id="uVehicule" placeholder="Ex: Peugeot 308" /></div>
        <div class="form-group"><label for="uCarburant">Type de carburant</label>
          <select id="uCarburant">
            <option value="Essence">Essence</option><option value="Diesel">Diesel</option><option value="Hybride">Hybride</option><option value="Électrique">Électrique</option><option value="GPL">GPL</option><option value="Autre">Autre</option>
          </select>
        </div>
        <div class="form-group"><label for="uCV">Puissance (CV)</label><input id="uCV" type="number" min="0" placeholder="Ex: 5" /></div>
      </div>
    </div>
  </div>

  <!-- Trajets -->
  <div class="tab-content" id="trips-tab">
    <div class="card">
      <h2><i class="fas fa-plus-circle"></i> Nouveau trajet</h2>
      <!-- Ligne 1 -->
      <div class="form-grid form-grid-4">
        <div class="form-group"><label for="tDate">Date</label><input id="tDate" type="date" /></div>
        <div class="form-group autocomplete"><label for="tDep">Départ</label><input id="tDep" placeholder="Nom de l'itinéraire" /><div class="autocomplete-list" id="departure-list"></div></div>
        <div class="form-group autocomplete"><label for="tArr">Arrivée</label><input id="tArr" placeholder="Nom de l'itinéraire" /><div class="autocomplete-list" id="arrival-list"></div></div>
        <div class="form-group"><label for="tKm">Distance (km)</label><input id="tKm" type="number" step="0.1" min="0" placeholder="0.0" /></div>
      </div>
      <!-- Ligne 2 alignée sous les colonnes -->
      <div class="form-grid form-grid-4">
        <div class="form-group">
          <label for="tMotif">Motif <span style="color:var(--danger)">*</span></label>
          <div class="motif-select">
            <div class="motif-option" data-value="Client"><i class="fas fa-users"></i> Client</div>
            <div class="motif-option" data-value="Prospect"><i class="fas fa-handshake"></i> Prospect</div>
            <div class="motif-option" data-value="Groupe d'affaire"><i class="fas fa-briefcase"></i> Groupe d'affaire</div>
            <div class="motif-option" data-value="Formation"><i class="fas fa-graduation-cap"></i> Formation</div>
            <div class="motif-option" data-value="Autres"><i class="fas fa-ellipsis-h"></i> Autres</div>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group"><input id="tAR" type="checkbox" /><label for="tAR">Aller-retour</label></div>
        </div>
        <div class="form-group">
          <div class="checkbox-group"><input id="tRecurrence" type="checkbox" /><label for="tRecurrence">Trajet récurrent</label></div>
        </div>
        <div class="form-group" style="justify-content:flex-end">
          <button id="btnOSM" class="btn-secondary"><i class="fas fa-calculator"></i> Calculer distance</button>
          <button id="btnAdd"><i class="fas fa-plus"></i> Ajouter trajet</button>
        </div>
      </div>
    </div>

    <div class="card">
      <!-- Titre sans le mois demandé -->
      <h2><i class="fas fa-list-alt"></i> Trajets</h2>
      <div class="month-selector">
        <div class="form-group"><label for="fMois">Mois/Année</label><input id="fMois" type="month" /></div>
        <div class="stats-container"><span>Statut:</span><span id="stat" class="status">—</span>
          <div class="export-buttons">
            <button id="btnCSV" class="btn-secondary"><i class="fas fa-file-csv"></i> CSV</button>
            <button id="btnXLSX" class="btn-secondary"><i class="fas fa-file-excel"></i> XLSX</button>
            <button id="btnPDF"><i class="fas fa-file-pdf"></i> PDF</button>
          </div>
        </div>
      </div>

      <table id="tab">
        <thead>
          <tr>
            <th>Date</th><th>Départ</th><th>Arrivée</th><th>Km</th><th>AR</th>
            <th class="mobile-hidden">Km effectifs</th><th class="mobile-hidden">Montant</th><th>Motif</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="summary">
        <div class="summary-item"><div class="summary-label">Total km effectifs</div><div id="totKm" class="summary-value">0</div></div>
        <div class="summary-item"><div class="summary-label">Total (mois)</div><div id="totEur" class="summary-value">0,00 €</div></div>
        <div class="summary-item"><div class="summary-label">Km annuels (1 jan - 31 déc)</div><div id="totKmAnnuels" class="summary-value">0</div></div>
      </div>
    </div>
  </div>

  <!-- Itinéraires -->
  <div class="tab-content" id="routes-tab">
    <div class="card">
      <h2><i class="fas fa-map-marked-alt"></i> Gestion des itinéraires</h2>
      <div class="form-grid">
        <div class="form-group"><label for="rNom">Nom</label><input id="rNom" placeholder="Ex: Client X — Siège" /></div>
        <div class="form-group"><label>Adresse</label>
          <div class="address-fields">
            <input id="rRue" placeholder="Rue" />
            <input id="rCodePostal" placeholder="Code Postal" />
            <input id="rVille" placeholder="Ville" />
          </div>
        </div>
        <div class="form-group" style="justify-content:flex-end"><button id="btnRAdd"><i class="fas fa-plus"></i> Ajouter itinéraire</button></div>
      </div>

      <div class="import-section">
        <h3><i class="fas fa-file-import"></i> Importer des itinéraires</h3>
        <p>Importez un fichier CSV ou XLSX avec les colonnes: Nom, Rue, Code Postal, Ville</p>
        <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="file-input" />
        <label for="importFile" class="file-label"><i class="fas fa-upload"></i> Choisir un fichier</label>
        <button id="btnImport" class="btn-secondary" style="margin-left:10px"><i class="fas fa-file-import"></i> Importer</button>
      </div>

      <div class="actions">
        <button id="btnExportCSV" class="btn-secondary"><i class="fas fa-file-csv"></i> Exporter CSV</button>
        <button id="btnExportXLSX" class="btn-secondary"><i class="fas fa-file-excel"></i> Exporter XLSX</button>
      </div>

      <table id="tabR">
        <thead><tr><th>Nom</th><th>Adresse</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Paramètres -->
  <div class="tab-content" id="settings-tab">
    <div class="card">
      <h2><i class="fas fa-cog"></i> Paramètres de l'application</h2>
      <p>Réinitialiser toutes les données enregistrées localement.</p>
      <button id="btnReset" class="btn-danger"><i class="fas fa-trash-alt"></i> Tout réinitialiser</button>

      <div class="import-section" style="margin-top:24px">
        <h3><i class="fas fa-shield-alt"></i> Sauvegarde et restauration</h3>
        <p>Exportez puis réimportez toutes vos données (Utilisateur, Trajets, Itinéraires) pour changer de PC.</p>
        <div class="actions">
          <button id="btnBackup" class="btn-success"><i class="fas fa-download"></i> Exporter les données</button>
          <input type="file" id="backupFile" accept=".json" class="file-input" />
          <label for="backupFile" class="file-label"><i class="fas fa-upload"></i> Choisir un fichier .json</label>
          <button id="btnImportAll" class="btn-secondary"><i class="fas fa-file-import"></i> Importer les données</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<!-- Modal récurrence -->
<div class="recurrence-modal" id="recurrenceModal">
  <div class="recurrence-content">
    <h2><i class="fas fa-calendar-alt"></i> Planification des trajets récurrents</h2>
    <div class="calendar-header">
      <button id="prevMonth" class="btn-secondary"><i class="fas fa-chevron-left"></i></button>
      <h3 id="currentMonthLabel">Mois 2025</h3>
      <button id="nextMonth" class="btn-secondary"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="calendar" id="calendar"></div>
    <div class="actions">
      <button id="cancelRecurrence" class="btn-secondary"><i class="fas fa-times"></i> Annuler</button>
      <button id="confirmRecurrence" class="btn-success"><i class="fas fa-check"></i> Confirmer</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    let trips=[]; let routes=[]; let selectedMotif='';

    const tabs=document.querySelectorAll('.tab');
    const tabContents=document.querySelectorAll('.tab-content');
    tabs.forEach(tab=>{tab.addEventListener('click',()=>{const id=tab.getAttribute('data-tab');tabs.forEach(t=>t.classList.remove('active'));tabContents.forEach(c=>c.classList.remove('active'));tab.classList.add('active');document.getElementById(id+'-tab').classList.add('active');});});

    const recurrenceCheckbox=document.getElementById('tRecurrence');
    const recurrenceModal=document.getElementById('recurrenceModal');
    if(recurrenceCheckbox){recurrenceCheckbox.addEventListener('change',()=>{if(recurrenceCheckbox.checked){recurrenceModal.classList.add('active');generateCalendar(new Date());}});}

    document.querySelectorAll('.motif-option').forEach(opt=>{opt.addEventListener('click',()=>{document.querySelectorAll('.motif-option').forEach(o=>o.classList.remove('selected'));opt.classList.add('selected');selectedMotif=opt.getAttribute('data-value');});});

    function setupLogo(){const c=document.createElement('canvas');c.width=360;c.height=100;const x=c.getContext('2d');x.fillStyle='#ffffff';x.fillRect(0,0,c.width,c.height);x.fillStyle='#2563eb';x.font='bold 42px system-ui';x.textAlign='left';x.textBaseline='middle';x.fillText('SALC',20,50);x.fillStyle='#475569';x.font='16px system-ui';x.fillText('Frais Kilométriques',100,50);document.getElementById('logo').src=c.toDataURL('image/png');}

    function bindEvents(){
      ['uNom','uMail','uPrix','uVehicule','uCarburant','uCV'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener(id==='uCarburant'?'change':'input',saveUser);});
      const d=new Date();const tDate=document.getElementById('tDate');const fMois=document.getElementById('fMois');if(tDate)tDate.valueAsDate=d;if(fMois)fMois.valueAsDate=d;
      const tKm=document.getElementById('tKm');const tAR=document.getElementById('tAR');if(tKm)tKm.addEventListener('input',updatePreview);if(tAR)tAR.addEventListener('change',updatePreview);
      const btnAdd=document.getElementById('btnAdd');if(btnAdd)btnAdd.addEventListener('click',addTrip);
      const btnOSM=document.getElementById('btnOSM');if(btnOSM)btnOSM.addEventListener('click',calcOSM);
      if(fMois)fMois.addEventListener('change',renderTrips);
      const btnRAdd=document.getElementById('btnRAdd');if(btnRAdd)btnRAdd.addEventListener('click',addRoute);
      const btnImport=document.getElementById('btnImport');if(btnImport)btnImport.addEventListener('click',importFile);
      const btnExportCSV=document.getElementById('btnExportCSV');if(btnExportCSV)btnExportCSV.addEventListener('click',()=>exportRoutes('csv'));
      const btnExportXLSX=document.getElementById('btnExportXLSX');if(btnExportXLSX)btnExportXLSX.addEventListener('click',()=>exportRoutes('xlsx'));
      const btnCSV=document.getElementById('btnCSV');if(btnCSV)btnCSV.addEventListener('click',exportCSV);
      const btnXLSX=document.getElementById('btnXLSX');if(btnXLSX)btnXLSX.addEventListener('click',exportXLSX);
      const btnPDF=document.getElementById('btnPDF');if(btnPDF)btnPDF.addEventListener('click',exportPDF);
      const btnReset=document.getElementById('btnReset');if(btnReset)btnReset.addEventListener('click',resetAll);
      const cancelRecurrence=document.getElementById('cancelRecurrence');if(cancelRecurrence)cancelRecurrence.addEventListener('click',()=>{recurrenceModal.classList.remove('active');recurrenceCheckbox.checked=false;});
      const confirmRecurrence=document.getElementById('confirmRecurrence');if(confirmRecurrence)confirmRecurrence.addEventListener('click',confirmRecurrenceHandler);
      const btnBackup=document.getElementById('btnBackup');if(btnBackup)btnBackup.addEventListener('click',exportAllData);
      const btnImportAll=document.getElementById('btnImportAll');if(btnImportAll)btnImportAll.addEventListener('click',importAllData);
    }

    function setupCalendarNavigation(){
      const prev=document.getElementById('prevMonth');const next=document.getElementById('nextMonth');
      if(prev)prev.addEventListener('click',()=>{const cur=new Date(document.getElementById('currentMonthLabel').dataset.date);cur.setMonth(cur.getMonth()-1);generateCalendar(cur);});
      if(next)next.addEventListener('click',()=>{const cur=new Date(document.getElementById('currentMonthLabel').dataset.date);cur.setMonth(cur.getMonth()+1);generateCalendar(cur);});
    }

    function generateCalendar(date){
      const cal=document.getElementById('calendar');const label=document.getElementById('currentMonthLabel');
      label.dataset.date=date.toISOString();
      const months=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
      label.textContent=`${months[date.getMonth()]} ${date.getFullYear()}`;
      cal.innerHTML='';
      ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(d=>{const e=document.createElement('div');e.className='calendar-weekday';e.textContent=d;cal.appendChild(e);});
      const first=new Date(date.getFullYear(),date.getMonth(),1);const last=new Date(date.getFullYear(),date.getMonth()+1,0);
      let dow=first.getDay();if(dow===0)dow=7;for(let i=1;i<dow;i++){const ed=document.createElement('div');ed.className='calendar-day disabled';cal.appendChild(ed);} 
      const today=new Date();
      for(let i=1;i<=last.getDate();i++){const day=document.createElement('div');day.className='calendar-day';day.textContent=i;day.dataset.day=i;day.dataset.month=(date.getMonth()+1);day.dataset.year=date.getFullYear();if(i===today.getDate()&&date.getMonth()===today.getMonth()&&date.getFullYear()===today.getFullYear())day.classList.add('today');day.addEventListener('click',()=>day.classList.toggle('selected'));cal.appendChild(day);} 
    }

    function setupAutocomplete(){
      const dep=document.getElementById('tDep');const arr=document.getElementById('tArr');const depList=document.getElementById('departure-list');const arrList=document.getElementById('arrival-list');
      function show(input,list){const v=(input.value||'').toLowerCase();list.innerHTML='';if(v.length<2){list.style.display='none';return;}const filtered=routes.filter(r=>r.name.toLowerCase().includes(v)||getFullAddress(r).toLowerCase().includes(v));if(filtered.length===0){list.style.display='none';return;}filtered.forEach(r=>{const item=document.createElement('div');item.className='autocomplete-item';item.textContent=`${r.name} - ${getFullAddress(r)}`;item.addEventListener('click',()=>{input.value=r.name;list.style.display='none';});list.appendChild(item);});list.style.display='block';}
      if(dep)dep.addEventListener('input',()=>show(dep,depList)); if(arr)arr.addEventListener('input',()=>show(arr,arrList));
      document.addEventListener('click',(e)=>{if(dep && !dep.contains(e.target))depList.style.display='none';if(arr && !arr.contains(e.target))arrList.style.display='none';});
    }

    function getFullAddress(route){return `${route.street}, ${route.postalCode} ${route.city}`}

    function setCurrentMonth(){const now=new Date();const m=now.toLocaleString('fr-FR',{month:'long'});const y=now.getFullYear();const badge=document.getElementById('moisBadge');if(badge)badge.textContent=`${m} ${y}`;/* titre mois retiré volontairement */}

    function saveUser(){const u={nom:val('uNom'),mail:val('uMail'),prix:parseFloat(val('uPrix'))||0.32,vehicule:val('uVehicule'),carburant:val('uCarburant')||'Essence',cv:val('uCV')};localStorage.setItem('user',JSON.stringify(u));showNotification('Informations sauvegardées');}

    function loadData(){try{const ud=localStorage.getItem('user');if(ud){const u=JSON.parse(ud);set('uNom',u.nom);set('uMail',u.mail);set('uPrix',u.prix??0.32);set('uVehicule',u.vehicule);set('uCarburant',u.carburant||'Essence');set('uCV',u.cv);} }catch(e){console.error('Load user',e)}
      try{const td=localStorage.getItem('trips');trips=td?JSON.parse(td):[];}catch(e){console.error('Load trips',e);trips=[]}
      try{const rd=localStorage.getItem('routes');routes=rd?JSON.parse(rd):[];}catch(e){console.error('Load routes',e);routes=[]}
    }

    function updatePreview(){const km=parseFloat(val('tKm'))||0;const isAR=checked('tAR');const p=parseFloat(val('uPrix'))||0.32;const eff=km*(isAR?2:1);const amt=eff*p;const s=document.getElementById('stat');if(s){s.textContent=`Est: ${amt.toFixed(2)} €`;s.className='status status-ok';}}

    function addTrip(){const date=val('tDate');const fromName=(val('tDep')||'').trim();const toName=(val('tArr')||'').trim();const km=parseFloat(val('tKm'));const isRoundTrip=checked('tAR');const motif=selectedMotif;const isRecurrent=checked('tRecurrence');
      if(!motif){showNotification('Le motif est obligatoire',true);return;}
      const fromRoute=routes.find(r=>r.name===fromName);const toRoute=routes.find(r=>r.name===toName);
      if(!fromRoute||!toRoute){showNotification('Veuillez sélectionner des itinéraires valides',true);return;}
      if(!date||isNaN(km)||km<=0){showNotification('Veuillez remplir tous les champs obligatoires',true);return;}
      if(isRecurrent){return;} // modal gère la suite
      const trip={id:Date.now().toString(),date,from:fromName,to:toName,fromAddress:getFullAddress(fromRoute),toAddress:getFullAddress(toRoute),km,isRoundTrip,motif};
      trips.push(trip);sortTrips();localStorage.setItem('trips',JSON.stringify(trips));showNotification('Trajet ajouté avec succès');
      set('tDep','');set('tArr','');set('tKm','');setChecked('tAR',false);setChecked('tRecurrence',false);document.querySelectorAll('.motif-option').forEach(o=>o.classList.remove('selected'));selectedMotif='';renderTrips();}

    function sortTrips(){trips.sort((a,b)=>new Date(a.date)-new Date(b.date))}

    function confirmRecurrenceHandler(){const fromName=(val('tDep')||'').trim();const toName=(val('tArr')||'').trim();const km=parseFloat(val('tKm'));const isRoundTrip=checked('tAR');const motif=selectedMotif;const fromRoute=routes.find(r=>r.name===fromName);const toRoute=routes.find(r=>r.name===toName);if(!fromRoute||!toRoute){showNotification('Veuillez sélectionner des itinéraires valides',true);return;}if(isNaN(km)||km<=0||!motif){showNotification('Veuillez remplir tous les champs obligatoires',true);return;}
      const days=document.querySelectorAll('.calendar-day.selected');if(days.length===0){showNotification('Veuillez sélectionner au moins un jour',true);return;}
      const today=new Date();const toAdd=[];days.forEach(d=>{const day=d.dataset.day;const month=d.dataset.month;const year=d.dataset.year;const tripDate=new Date(year,month-1,day);if(tripDate<new Date(today.getFullYear(),today.getMonth(),today.getDate()))return;const formatted=`${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;toAdd.push({id:Date.now().toString()+Math.random(),date:formatted,from:fromName,to:toName,fromAddress:getFullAddress(fromRoute),toAddress:getFullAddress(toRoute),km,isRoundTrip,motif});});
      trips=[...trips,...toAdd];sortTrips();localStorage.setItem('trips',JSON.stringify(trips));recurrenceModal.classList.remove('active');setChecked('tRecurrence',false);set('tDep','');set('tArr','');set('tKm','');setChecked('tAR',false);document.querySelectorAll('.motif-option').forEach(o=>o.classList.remove('selected'));selectedMotif='';showNotification(`${toAdd.length} trajets récurrents ajoutés`);renderTrips();}

    function renderTrips(){const m=val('fMois');const tbody=document.querySelector('#tab tbody');if(!tbody)return;tbody.innerHTML='';const price=parseFloat(val('uPrix'))||0.32;let totalKm=0,totalAmount=0;const monthly=trips.filter(t=>t.date.startsWith(m)).sort((a,b)=>new Date(a.date)-new Date(b.date));monthly.forEach(t=>{const eff=t.km*(t.isRoundTrip?2:1);const amt=eff*price;totalKm+=eff;totalAmount+=amt;const tr=document.createElement('tr');tr.innerHTML=`
          <td>${t.date}</td>
          <td>${t.from}<br><small>${t.fromAddress}</small></td>
          <td>${t.to}<br><small>${t.toAddress}</small></td>
          <td>${t.km}</td>
          <td>${t.isRoundTrip?'Oui':'Non'}</td>
          <td class="mobile-hidden">${eff.toFixed(1)}</td>
          <td class="mobile-hidden">${amt.toFixed(2)} €</td>
          <td>${t.motif||''}</td>
          <td><button class="btn-danger" data-id="${t.id}"><i class="fas fa-trash-alt"></i></button></td>`;tr.querySelector('button').addEventListener('click',()=>deleteTrip(t.id));tbody.appendChild(tr);});
      const curYear=new Date().getFullYear();const annual=trips.filter(t=>t.date>=`${curYear}-01-01`&&t.date<=`${curYear}-12-31`);const totalKmAnnual=annual.reduce((s,t)=>s+(t.km*(t.isRoundTrip?2:1)),0);setText('totKm',totalKm.toFixed(1));setText('totEur',`${totalAmount.toFixed(2)} €`);setText('totKmAnnuels',totalKmAnnual.toFixed(1));}

    function deleteTrip(id){if(confirm('Êtes-vous sûr de vouloir supprimer ce trajet ?')){trips=trips.filter(t=>t.id!==id);localStorage.setItem('trips',JSON.stringify(trips));renderTrips();showNotification('Trajet supprimé');}}

    async function calcOSM(){const fromName=(val('tDep')||'').trim();const toName=(val('tArr')||'').trim();if(!fromName||!toName){showNotification('Veuillez saisir les itinéraires de départ et d\'arrivée',true);return;}const fromRoute=routes.find(r=>r.name===fromName);const toRoute=routes.find(r=>r.name===toName);if(!fromRoute||!toRoute){showNotification('Veuillez sélectionner des itinéraires valides',true);return;}const fromAddr=getFullAddress(fromRoute);const toAddr=getFullAddress(toRoute);const stat=document.getElementById('stat');const btn=document.getElementById('btnOSM');if(stat){stat.textContent='Calcul en cours...';stat.className='status';}if(btn)btn.disabled=true;try{const from=await geocodeAddress(fromAddr);const to=await geocodeAddress(toAddr);if(!from||!to)throw new Error('Géocodage');const res=await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false`);if(!res.ok)throw new Error('OSRM');const data=await res.json();if(data.routes&&data.routes.length>0){const d=(data.routes[0].distance/1000).toFixed(1);set('tKm',d);updatePreview();if(stat){stat.textContent=`Distance calculée: ${d} km`;stat.className='status status-ok';}showNotification('Distance calculée avec succès');}else{throw new Error('Aucun itinéraire');}}catch(e){console.error(e);if(stat){stat.textContent='Erreur de calcul';stat.className='status status-error';}showNotification('Erreur lors du calcul de la distance',true);}finally{if(btn)btn.disabled=false;}}

    async function geocodeAddress(address){try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);if(!r.ok)throw new Error('Geocode');const d=await r.json();if(d&&d.length>0)return{lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)};throw new Error('Adresse non trouvée');}catch(e){console.error('Geocode',e);return null;}}

    function addRoute(){const name=(val('rNom')||'').trim();const street=(val('rRue')||'').trim();const postal=(val('rCodePostal')||'').trim();const city=(val('rVille')||'').trim();if(!name||!street||!postal||!city){showNotification('Veuillez remplir tous les champs',true);return;}const route={id:Date.now().toString(),name,street,postalCode:postal,city};routes.push(route);localStorage.setItem('routes',JSON.stringify(routes));set('rNom','');set('rRue','');set('rCodePostal','');set('rVille','');renderRoutes();showNotification('Itinéraire ajouté avec succès');}

    function importFile(){const fi=document.getElementById('importFile');const file=fi.files[0];if(!file){showNotification('Veuillez sélectionner un fichier',true);return;}const reader=new FileReader();reader.onload=e=>{const data=e.target.result;let count=0;try{if(/\.xlsx?$/.test(file.name)){const wb=XLSX.read(data,{type:'binary'});const sh=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(sh);json.forEach(row=>{if(row.Nom&&row.Rue&&row['Code Postal']&&row.Ville){routes.push({id:Date.now().toString()+count,name:row.Nom,street:row.Rue,postalCode:row['Code Postal'],city:row.Ville});count++;}});}else{const lines=data.split(/\r?\n/);let i=0;if(lines[0]&&lines[0].toLowerCase().includes('nom'))i=1;for(;i<lines.length;i++){const line=(lines[i]||'').trim();if(!line)continue;const parts=line.split(',');if(parts.length>=4){const [name,street,postal,city]=parts.map(s=>s.trim());if(name&&street&&postal&&city){routes.push({id:Date.now().toString()+count,name,street,postalCode:postal,city});count++;}}}}localStorage.setItem('routes',JSON.stringify(routes));renderRoutes();showNotification(`${count} itinéraires importés avec succès`);fi.value='';}catch(err){console.error('Import',err);showNotification('Erreur lors de l\'importation du fichier',true);}};if(/\.xlsx?$/.test(file.name))reader.readAsBinaryString(file);else reader.readAsText(file);}

    function exportRoutes(fmt){if(routes.length===0){showNotification('Aucun itinéraire à exporter',true);return;}try{if(fmt==='csv'){let csv='Nom,Rue,Code Postal,Ville\n';routes.forEach(r=>{csv+=`"${r.name}","${r.street}","${r.postalCode}","${r.city}"\n`;});downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),`itineraires_${new Date().toISOString().slice(0,10)}.csv`);showNotification('Itinéraires exportés en CSV avec succès');}else{const data=routes.map(r=>({Nom:r.name,Rue:r.street,'Code Postal':r.postalCode,Ville:r.city}));const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Itinéraires');XLSX.writeFile(wb,`itineraires_${new Date().toISOString().slice(0,10)}.xlsx`);showNotification('Itinéraires exportés en XLSX avec succès');}}catch(e){console.error('Export',e);showNotification('Erreur lors de l\'exportation',true);}}

    function renderRoutes(){const tbody=document.querySelector('#tabR tbody');if(!tbody)return;tbody.innerHTML='';routes.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.name}</td><td>${getFullAddress(r)}</td><td><button class=\"btn-danger\" data-id=\"${r.id}\"><i class=\"fas fa-trash-alt\"></i></button></td>`;tr.querySelector('button').addEventListener('click',()=>deleteRoute(r.id));tbody.appendChild(tr);});}

    function deleteRoute(id){if(confirm('Êtes-vous sûr de vouloir supprimer cet itinéraire ?')){routes=routes.filter(r=>r.id!==id);localStorage.setItem('routes',JSON.stringify(routes));renderRoutes();showNotification('Itinéraire supprimé');}}

    function exportCSV(){const m=val('fMois');const u=getUser();const year=new Date().getFullYear();const annual=trips.filter(t=>t.date>=`${year}-01-01`&&t.date<=`${year}-12-31`);const totYear=annual.reduce((s,t)=>s+(t.km*(t.isRoundTrip?2:1)),0);let csv='Date,Nom Départ,Adresse Départ,Nom Arrivée,Adresse Arrivée,KM,Aller-retour,KM effectifs,Montant,Motif\n';const ex=trips.filter(t=>t.date.startsWith(m)).sort((a,b)=>new Date(a.date)-new Date(b.date));let tKm=0,tAmt=0;ex.forEach(t=>{const eff=t.km*(t.isRoundTrip?2:1),amt=eff*u.prix;tKm+=eff;tAmt+=amt;const esc=v=>`"${String(v).replace(/\"/g,'\"\"')}"`;csv+=`${t.date},${esc(t.from)},${esc(t.fromAddress)},${esc(t.to)},${esc(t.toAddress)},${t.km},${t.isRoundTrip?'Oui':'Non'},${eff},${amt.toFixed(2)},${esc(t.motif||'')}\n`;});csv+=`\nTOTAL,,,,,,${tKm.toFixed(1)},${tAmt.toFixed(2)},\n`;csv+=`\nInformations utilisateur:\nNom: ${u.nom}\nEmail: ${u.mail||'Non renseigné'}\nPrix du km: ${u.prix.toFixed(3)}\nVéhicule: ${u.vehicule||'Non renseigné'}\nCarburant: ${u.carburant||'Non renseigné'}\nCV: ${u.cv||'Non renseigné'}\nKilométrage annuel (1 jan - 31 déc): ${totYear.toFixed(1)} km\n`;downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),`frais_kilometriques_${m}.csv`);showNotification('Fichier CSV exporté avec succès');}

    function exportXLSX(){const m=val('fMois');const u=getUser();const year=new Date().getFullYear();const annual=trips.filter(t=>t.date>=`${year}-01-01`&&t.date<=`${year}-12-31`);const totYear=annual.reduce((s,t)=>s+(t.km*(t.isRoundTrip?2:1)),0);const rows=[];let tKm=0,tAmt=0;const ex=trips.filter(t=>t.date.startsWith(m)).sort((a,b)=>new Date(a.date)-new Date(b.date));ex.forEach(t=>{const eff=t.km*(t.isRoundTrip?2:1),amt=eff*u.prix;tKm+=eff;tAmt+=amt;rows.push({Date:t.date,'Nom Départ':t.from,'Adresse Départ':t.fromAddress,'Nom Arrivée':t.to,'Adresse Arrivée':t.toAddress,KM:t.km,'Aller-retour':t.isRoundTrip?'Oui':'Non','KM effectifs':eff,Montant:amt.toFixed(2),Motif:t.motif||''});});rows.push({Date:'TOTAL','KM effectifs':tKm.toFixed(1),Montant:tAmt.toFixed(2)});const info=[{'Informations utilisateur':''},{Nom:u.nom},{Email:u.mail||'Non renseigné'},{'Prix du km':u.prix.toFixed(3)},{Véhicule:u.vehicule||'Non renseigné'},{Carburant:u.carburant||'Non renseigné'},{CV:u.cv||'Non renseigné'},{'Kilométrage annuel (1 jan - 31 déc)':`${totYear.toFixed(1)} km`}];const ws=XLSX.utils.json_to_sheet(rows);const ws2=XLSX.utils.json_to_sheet(info);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Trajets');XLSX.utils.book_append_sheet(wb,ws2,'Informations');XLSX.writeFile(wb,`frais_kilometriques_${m}.xlsx`);showNotification('Fichier XLSX exporté avec succès');}

    function exportPDF(){const m=val('fMois');const u=getUser();const year=new Date().getFullYear();const annual=trips.filter(t=>t.date>=`${year}-01-01`&&t.date<=`${year}-12-31`);const totYear=annual.reduce((s,t)=>s+(t.km*(t.isRoundTrip?2:1)),0);const { jsPDF }=window.jspdf;const doc=new jsPDF();doc.setFontSize(20);doc.setTextColor(37,99,235);doc.text('Note de Frais Kilométriques SALC',105,20,{align:'center'});doc.setFontSize(12);doc.setTextColor(30,41,59);doc.text(`Période: ${m}`,20,35);doc.text(`Nom: ${u.nom}`,20,45);doc.text(`Email: ${u.mail||'Non renseigné'}`,20,55);doc.text(`Prix du km: ${u.prix.toFixed(3)} €`,20,65);doc.text(`Véhicule: ${u.vehicule||'Non renseigné'}`,20,75);doc.text(`Carburant: ${u.carburant||'Non renseigné'}`,20,85);doc.text(`CV: ${u.cv||'Non renseigné'}`,20,95);
      const ex=trips.filter(t=>t.date.startsWith(m)).sort((a,b)=>new Date(a.date)-new Date(b.date));const body=[];let tKm=0,tAmt=0;ex.forEach(t=>{const eff=t.km*(t.isRoundTrip?2:1),amt=eff*u.prix;tKm+=eff;tAmt+=amt;body.push([t.date,t.from,t.fromAddress,t.to,t.toAddress,String(t.km),t.isRoundTrip?'Oui':'Non',eff.toFixed(1),`${amt.toFixed(2)} €`,t.motif||'']);});doc.autoTable({startY:105,head:[['Date','Nom Départ','Adresse Départ','Nom Arrivée','Adresse Arrivée','KM','AR','KM Effectifs','Montant €','Motif']],body,theme:'grid',headStyles:{fillColor:[37,99,235],textColor:255},alternateRowStyles:{fillColor:[241,245,249]},styles:{fontSize:7,cellPadding:2},margin:{top:105}});const y=doc.lastAutoTable.finalY||105;doc.setFontSize(12);doc.setFont(undefined,'bold');doc.text(`Total KM effectifs: ${tKm.toFixed(1)}`,20,y+20);doc.text(`Total €: ${tAmt.toFixed(2)} €`,20,y+35);doc.text(`Kilométrage annuel (1 jan - 31 déc): ${totYear.toFixed(1)} km`,20,y+50);doc.save(`frais_kilometriques_${m}.pdf`);showNotification('PDF généré');}

    // Sauvegarde / restauration globale
    function exportAllData(){const payload={schema:'salc-km-v1',exportedAt:new Date().toISOString(),user:JSON.parse(localStorage.getItem('user')||'{}'),trips:JSON.parse(localStorage.getItem('trips')||'[]'),routes:JSON.parse(localStorage.getItem('routes')||'[]')};const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});downloadBlob(blob,`sauvegarde_salc_${new Date().toISOString().slice(0,10)}.json`);showNotification('Export des données effectué');}

    function importAllData(){const fi=document.getElementById('backupFile');const file=fi.files&&fi.files[0];if(!file){showNotification('Sélectionnez un fichier de sauvegarde',true);return;}const reader=new FileReader();reader.onload=e=>{try{const data=JSON.parse(e.target.result);if(!data||typeof data!=='object'){throw new Error('Format invalide');}if(!confirm('Importer ces données et écraser les données locales ?'))return;localStorage.setItem('user',JSON.stringify(data.user||{}));localStorage.setItem('trips',JSON.stringify(data.trips||[]));localStorage.setItem('routes',JSON.stringify(data.routes||[]));loadData();renderRoutes();renderTrips();showNotification('Import des données réussi');}catch(err){console.error('Import all',err);showNotification('Fichier invalide',true);}finally{fi.value='';}};reader.readAsText(file);
    }

    function showNotification(msg,isError=false){const n=document.getElementById('notification');if(!n)return;n.textContent=msg;n.classList.remove('error','warning');if(isError)n.classList.add('error');n.classList.add('show');setTimeout(()=>n.classList.remove('show'),2200)}

    function resetAll(){if(!confirm('Confirmer la réinitialisation totale ?'))return;localStorage.removeItem('user');localStorage.removeItem('trips');localStorage.removeItem('routes');trips=[];routes=[];loadData();renderRoutes();renderTrips();showNotification('Données réinitialisées');}

    // helpers
    function val(id){const el=document.getElementById(id);return el?el.value:null}
    function set(id,v){const el=document.getElementById(id);if(el!=null)el.value=v??''}
    function checked(id){const el=document.getElementById(id);return !!(el&&el.checked)}
    function setChecked(id,v){const el=document.getElementById(id);if(el)el.checked=!!v}
    function setText(id,t){const el=document.getElementById(id);if(el)el.textContent=t}
    function getUser(){try{return JSON.parse(localStorage.getItem('user')||'{}')}catch(e){return {prix:0.32}}}
    function downloadBlob(blob,filename){const a=document.createElement('a');const url=URL.createObjectURL(blob);a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},0)}

    // init
    setupLogo();
    bindEvents();
    loadData();
    renderRoutes();
    renderTrips();
    setupAutocomplete();
    setCurrentMonth();
    setupCalendarNavigation();
  });
</script>
</body>
</html>